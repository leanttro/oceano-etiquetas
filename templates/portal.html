<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Cliente | Oceano Etiquetas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- TEMA OCEANO PORTAL (Azul) --- */
        :root {
            --background: #f8fafc; /* Fundo Claro */
            --surface: #ffffff; /* Cards Brancos */
            --border: #e5e7eb; /* Borda Cinza */
            --text-primary: #0f172a; /* Texto Escuro (Azul) */
            --text-secondary: #64748b; /* Texto Cinza */
            --accent: #2563eb; /* Azul Oceano (primary) */
            --accent-hover: #1d4ed8; /* Azul Oceano Hover */
            
            --font-body: 'Inter', sans-serif;
            --font-heading: 'Montserrat', sans-serif;
            
            --status-pending: #facc15; /* Amarelo */
            --status-confirmed: #10b981; /* Verde */
            --status-rejected: #ef4444; /* Vermelho */
            --status-default: #6b7280; /* Cinza */
            --status-enviado: #a855f7; /* Roxo */
            
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-body); background-color: var(--background);
            color: var(--text-primary); line-height: 1.6;
            min-height: 100vh; display: flex;
        }
        
        /* --- LOGIN (Design Oceano) --- */
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: var(--text-primary); /* Fundo Azul Escuro */
            z-index: 2000; display: flex; align-items: center; justify-content: center; 
        }
        .login-box { 
            background-color: var(--surface); 
            padding: 3rem; border-radius: 12px; border: 1px solid var(--border); 
            width: 100%; max-width: 400px; text-align: center; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
        }
        .login-box h2 { font-size: 2rem; margin-bottom: 2rem; color: var(--text-primary); }
        .input-group { margin-bottom: 1.5rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-primary); }
        .input-group input { 
            width: 100%; padding: 0.8rem; border-radius: 8px; 
            border: 1px solid var(--border); 
            background-color: var(--background); 
            color: var(--text-primary); font-family: var(--font-body); 
        }
        .input-group input:focus { border-color: var(--accent); outline: none; }
        .logo-img { height: 60px; margin-bottom: 1.5rem; border-radius: 8px;} 
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background-color: var(--accent); color: #FFF; }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .error-msg { color: var(--status-rejected); margin-top: 1rem; display: none; }

        /* --- LAYOUT PRINCIPAL (Portal) --- */
        #client-portal { display: none; flex: 1; }
        
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--text-primary); /* Sidebar Azul Escura */
            color: var(--text-secondary);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            flex-shrink: 0;
            position: fixed;
            height: 100vh;
        }
        .sidebar-logo {
            text-align: center;
            padding: 10px 20px 30px;
            border-bottom: 1px solid var(--border);
        }
        .sidebar-logo img {
            height: 40px;
            margin-bottom: 5px;
        }
        .sidebar-logo p {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
        }
        .nav-menu li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            gap: 10px;
        }
        .nav-menu li a i { width: 20px; text-align: center; }
        .nav-menu li a:hover, .nav-menu li a.active {
            color: var(--text-primary);
            background-color: var(--accent-hover);
            border-left: 3px solid var(--accent);
        }
        .nav-menu li a.active {
             border-left: 3px solid var(--text-primary);
        }
        .sidebar-footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
        }
        
        /* Conte칰do Principal */
        .main-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            margin-left: var(--sidebar-width); /* Compensa a sidebar fixa */
        }

        .content-header {
            background-color: var(--surface);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-header h1 {
            font-size: 1.5rem;
            color: var(--accent);
        }
        .btn-logout {
            padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--accent);
            color: var(--accent); border-radius: 6px; cursor: pointer; transition: all 0.3s;
        }
        .btn-logout:hover { background: var(--accent); color: var(--surface); }

        .content-section {
            padding: 30px;
        }
        
        /* Estilos Comuns */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-card .number {
            font-size: 2.5rem;
            font-family: var(--font-heading);
            color: var(--accent);
            line-height: 1.2;
        }
        .stat-card .label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .data-table {
            width: 100%; border-collapse: collapse; 
            background-color: var(--surface); 
            border-radius: 8px; overflow: hidden; 
            border: 1px solid var(--border);
        }
        .data-table th, .data-table td {
            padding: 1rem; text-align: left; border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        .data-table th { background-color: var(--background); color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; }
        
        .status-badge { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #fff; display: inline-block; }
        .status-Aguardando-Or칞amento { background-color: var(--status-pending); color: #000; }
        .status-Aguardando-Pagamento { background-color: #3B82F6; color: #fff; }
        .status-Pago, .status-Pago-(Aguardando-Verifica칞칚o) { background-color: var(--status-confirmed); }
        .status-Em-Produ칞칚o { background-color: var(--status-default); }
        .status-Enviado, .status-Pronto-para-Retirada { background-color: var(--status-enviado); }
        .status-Convertido-em-Pedido { background-color: var(--status-confirmed); }
        .status-Cancelado { background-color: var(--status-rejected); }

        /* --- Se칞칚o: Novo Or칞amento --- */
        #novo-orcamento-view .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            align-items: flex-start;
        }
        .product-list-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
        }
        .product-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }
        .product-item:last-child { border-bottom: none; }
        .product-image-box {
            flex-shrink: 0; width: 60px; height: 60px; border-radius: 4px;
            overflow: hidden; background-color: var(--background);
        }
        .product-image-box img { width: 100%; height: 100%; object-fit: cover; }
        .product-details { flex-grow: 1; }
        .product-details h3 { font-size: 1.1rem; color: var(--text-primary); margin-bottom: 5px; }
        .product-details p { font-size: 0.85rem; color: var(--text-secondary); }
        .product-actions { display: flex; align-items: center; gap: 10px; }
        .product-actions input[type="number"] {
            width: 70px; padding: 5px 8px; text-align: center;
            border: 1px solid var(--border); border-radius: 4px;
            background: var(--background); color: var(--text-primary);
        }
        
        .cart-summary {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            position: sticky;
            top: 30px;
        }
        #cart-items-list .cart-item {
            font-size: 0.9rem;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border);
        }
        #cart-items-list .cart-item strong { color: var(--accent); }
        
        /* --- CHATBOT (Tema Oceano Azul) --- */
        .floating-chatbot { position: fixed; bottom: 15px; right: 15px; z-index: 9999; }
        #chatbotButtonContainer { max-width: 350px; margin-left: auto; }
        .chatbot-preview-button {
            width: 100%;
            background-color: var(--surface); 
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            opacity: 1; visibility: visible; transform: scale(1);
        }
        .chatbot-preview-button:hover { transform: scale(1.03); }
        .chatbot-preview-button.hidden { opacity: 0; transform: scale(0.9); visibility: hidden; height: 0; padding: 0; }
        .chatbot-minimized-icon {
            width: 60px; height: 60px;
            background: var(--accent);
            border-radius: 50%;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; color: #FFFFFF;
            cursor: pointer; position: absolute; bottom: 0; right: 0;
            opacity: 0; visibility: hidden; transform: scale(0.5); transition: all 0.3s ease;
        }
        .chatbot-minimized-icon.minimized { opacity: 1; visibility: visible; transform: scale(1); }
        .preview-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        .preview-avatar {
            width: 35px; height: 35px; background: var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1rem; color: #FFFFFF; flex-shrink: 0;
        }
        .preview-info strong { font-weight: 700; color: var(--text-primary); font-size: 0.9rem; }
        .preview-info span { display: block; font-size: 0.75rem; color: var(--text-secondary); }
        .preview-message-bubble {
            background-color: var(--background);
            border-left: 3px solid var(--accent);
            padding: 0.8rem 1rem; border-radius: 8px;
            font-size: 0.85rem; line-height: 1.5; color: var(--text-primary);
        }
        
        .chatbot-window {
            position: fixed; bottom: 15px; right: 15px;
            width: 90%; max-width: 400px;
            height: 70vh; max-height: 550px;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            display: none; flex-direction: column;
            overflow: hidden; z-index: 9998;
            opacity: 0; transform: translateY(20px); transition: all 0.3s ease;
        }
        .chatbot-window.active { display: flex; opacity: 1; transform: translateY(0); }
        .chatbot-header {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            padding: 1.2rem 1.5rem;
            display: flex; align-items: center; gap: 1rem;
        }
        .chatbot-header-avatar {
            width: 45px; height: 45px; background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: #FFFFFF; flex-shrink: 0;
        }
        .chatbot-header-info h3 { font-size: 1.1rem; color: #FFFFFF; margin: 0; }
        .chatbot-header-info p { font-size: 0.75rem; opacity: 0.9; color: #FFFFFF; margin: 0; }
        .chatbot-close {
            margin-left: auto; background: none; border: none; color: #FFFFFF;
            font-size: 1.5rem; cursor: pointer; transition: background-color 0.3s ease;
        }
        .chatbot-messages {
            flex: 1; padding: 1rem; overflow-y: auto;
            display: flex; flex-direction: column; gap: 1rem;
            background-color: var(--background);
        }
        .message { display: flex; gap: 0.8rem; max-width: 90%; }
        .message.bot { align-self: flex-start; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message-avatar {
            width: 35px; height: 35px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; flex-shrink: 0; color: #FFFFFF;
        }
        .message.bot .message-avatar { background: var(--accent); }
        .message.user .message-avatar { background-color: var(--text-secondary); }
        .message-content { max-width: calc(100% - 45px); }
        .message-bubble {
            padding: 0.8rem 1rem; border-radius: 12px;
            font-size: 0.9rem; line-height: 1.5; word-wrap: break-word;
        }
        .message.bot .message-bubble { background-color: var(--surface); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .message.user .message-bubble { background-color: var(--accent); color: #FFFFFF; border-bottom-right-radius: 4px; }
        .message-bubble strong { font-weight: 700; }
        .message-time { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.4rem; }
        .message.user .message-time { text-align: right; }
        .typing-indicator { display: flex; gap: 0.3rem; padding: 0.8rem 1rem; }
        .typing-indicator span {
            width: 8px; height: 8px; background-color: var(--accent);
            border-radius: 50%; animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { opacity: 0.3; transform: translateY(0); } 30% { opacity: 1; transform: translateY(-8px); } }
        .chatbot-input-area {
            padding: 1rem; background-color: var(--surface);
            border-top: 1px solid var(--border); display: flex; gap: 0.8rem;
        }
        .chatbot-input {
            flex: 1; background-color: var(--background);
            border: 1px solid var(--border); border-radius: 20px;
            padding: 0.8rem 1rem; color: var(--text-primary);
            font-family: var(--font-body); font-size: 0.9rem; outline: none;
        }
        .chatbot-input:focus { border-color: var(--accent); }
        .chatbot-send {
            background: var(--accent); border: none; border-radius: 50%;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            color: #FFFFFF; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;
        }
        .chatbot-send:hover { background-color: var(--accent-hover); }
        .chatbot-send:disabled { opacity: 0.5; cursor: not-allowed; }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: static; }
            .main-content { margin-left: 0; }
            #novo-orcamento-view .layout { grid-template-columns: 1fr; }
            .cart-summary { position: static; top: 0; }
            .floating-chatbot { right: 15px; left: 15px; }
            .chatbot-window { right: 15px; left: 15px; width: auto; }
        }

        /* CORRE칂츾O DO BOT츾O "OK" FLUTUANTE */
        #custom-dialog-modal {
            display: none; /* Garante que o modal est치 escondido por padr칚o */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="/static/oceanologo.png" alt="Oceano Etiquetas Logo" class="logo-img">
            <h2>Portal do Cliente</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="client-codigo">C칩digo de Acesso</label>
                    <input type="password" id="client-codigo" required placeholder="Digite seu c칩digo de acesso">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button> 
                <p class="error-msg" id="login-error">C칩digo inv치lido.</p>
            </form>
        </div>
    </div>

    <div id="client-portal">
        <div class="sidebar">
            <div class="sidebar-logo">
                <img src="/static/oceanologo.png" alt="Oceano Etiquetas Logo">
                <p id="client-name-display">[Nome do Cliente]</p>
            </div>
            <ul class="nav-menu">
                <li><a href="#" class="nav-link active" data-view="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="#" class="nav-link" data-view="novo-orcamento"><i class="fas fa-plus-circle"></i> <span>Novo Or칞amento</span></a></li>
                <li><a href="#" class="nav-link" data-view="meus-pedidos"><i class="fas fa-receipt"></i> <span>Meus Pedidos</span></a></li>
                <li><a href="#" class="nav-link" data-view="falar-chat"><i class="fas fa-robot"></i> <span>Falar com Agente</span></a></li>
            </ul>
            <div class="sidebar-footer">
                <button class="btn-logout" id="logout-btn" style="width: 100%;">Sair <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="main-content">
            <div class="content-header">
                <h1 id="page-title">Dashboard</h1>
            </div>

            <div class="content-view active" id="dashboard-view">
                <div class="content-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="number" id="stat-aguardando-pagamento">-</div>
                            <div class="label">Aguardando Pagamento</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="stat-em-producao">-</div>
                            <div class="label">Pedidos em Produ칞칚o</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="stat-prontos">-</div>
                            <div class="label">Enviados / Prontos</div>
                        </div>
                    </div>
                    
                    <h2>Seus Pedidos Recentes</h2>
                    <table class="data-table" id="last-orders-table">
                        <thead>
                            <tr><th>ID</th><th>Tipo</th><th>Status</th><th>Valor</th><th>Rastreio</th></tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" style="text-align: center;">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="content-view" id="novo-orcamento-view" style="display:none;">
                 <div class="content-section">
                    <div class="layout">
                        <div class="product-list-container">
                            <div id="product-list">
                                <p style="padding: 2rem; text-align: center;">Carregando produtos...</p>
                            </div>
                        </div>
                        <div class="cart-summary">
                            <h3>Itens da Solicita칞칚o</h3>
                            <div id="cart-items-list" style="margin: 1rem 0;">
                                <p id="cart-empty-msg" style="color: var(--text-secondary);">Nenhum item adicionado.</p>
                            </div>
                            <button class="btn btn-primary" id="submit-orcamento-btn" style="width: 100%;">
                                <i class="fas fa-paper-plane"></i> Enviar Solicita칞칚o
                            </button>
                            <p class="success-msg" id="orcamento-success-msg"></p>
                            <p class="error-msg" id="orcamento-error-msg"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-view" id="meus-pedidos-view" style="display:none;">
                <div class="content-section">
                    <h2>Hist칩rico de Or칞amentos e Pedidos</h2>
                    <table class="data-table" id="all-orders-table">
                        <thead>
                            <tr><th>ID</th><th>Tipo</th><th>Data</th><th>Status</th><th>Valor Total</th><th>Rastreio</th><th>PIX</th></tr>
                        </thead>
                        <tbody>
                             <tr><td colspan="7" style="text-align: center;">Carregando hist칩rico...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="content-view" id="falar-chat-view" style="display:none;">
                <div class="content-section">
                    <h2>Oceano Bot - Agente Virtual</h2>
                    <p>O chatbot foi aberto no canto da tela. Fa칞a sua pergunta por l치!</p>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-chatbot" id="floatingChatbot" style="display:none;">
        <div id="chatbotButtonContainer">
             <div class="chatbot-minimized-icon" id="minimizedIcon" aria-label="Abrir Chatbot">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chatbot-preview-button" id="chatbotButton" aria-label="Abrir Oceano Bot">
                <button class="preview-close" id="previewClose" aria-label="Minimizar Preview">
                    <i class="fas fa-times"></i>
                </button>
                <div class="preview-header">
                    <div class="preview-avatar">O</div>
                    <div class="preview-info">
                        <strong>Oceano Bot</strong>
                        <span>Assistente Virtual</span>
                    </div>
                </div>
                <div class="preview-message-bubble">
                    <span id="preview-message-text">Ol치! 游녦 Posso ajudar com um or칞amento ou status de pedido?</span>
                </div>
            </div>
        </div>

        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div class="chatbot-header-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="chatbot-header-info">
                    <h3>Oceano Bot</h3>
                    <p>Assistente Virtual Oceano</p>
                </div>
                <button class="chatbot-close" id="chatbotClose" aria-label="Fechar chat">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                </div>
            <div class="chatbot-input-area">
                <input 
                    type="text" 
                    class="chatbot-input" 
                    id="chatbotInput" 
                    placeholder="Digite sua mensagem..."
                    autocomplete="off">
                <button class="chatbot-send" id="chatbotSend" aria-label="Enviar mensagem">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="custom-dialog-modal" class="modal-overlay">
        <div style="background: var(--surface); padding: 2rem; border-radius: 8px; max-width: 400px; text-align: center;">
            <p id="dialog-message" style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.1rem;"></p>
            <div id="dialog-buttons" style="display: flex; justify-content: center; gap: 1rem;">
                <button type="button" class="btn btn-primary" id="dialog-ok-btn">OK</button>
            </div>
        </div>
    </div>

    <script>
        // URLs da API (do app.py)
        const API_CLIENT_URL = '/api/oceano/cliente';
        const API_CHAT_URL = '/api/oceano/chat';
        const API_PRODUTOS_URL = '/api/produtos'; // API P칰blica
        
        let CLIENT_TOKEN = null;
        let CLIENT_ID = null;
        let CLIENT_NAME = null;
        
        // --- Carrinho de Or칞amento ---
        let orcamentoCart = {};
        let productsMap = {};

        // --- Seletores DOM ---
        const loginScreen = document.getElementById('login-screen');
        const clientPortal = document.getElementById('client-portal');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-btn');
        const loginErrorMsg = document.getElementById('login-error');
        const clientNameDisplay = document.getElementById('client-name-display');
        const pageTitle = document.getElementById('page-title');
        
        // --- Seletores de View ---
        const views = document.querySelectorAll('.content-view');
        const navLinks = document.querySelectorAll('.nav-link');

        // --- Seletores Dashboard ---
        const statAguardandoPagamento = document.getElementById('stat-aguardando-pagamento');
        const statEmProducao = document.getElementById('stat-em-producao');
        const statProntos = document.getElementById('stat-prontos');
        const lastOrdersTable = document.querySelector('#last-orders-table tbody');
        
        // --- Seletores Novo Or칞amento ---
        const productListContainer = document.getElementById('product-list');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartEmptyMsg = document.getElementById('cart-empty-msg');
        const submitOrcamentoBtn = document.getElementById('submit-orcamento-btn');
        const orcamentoSuccessMsg = document.getElementById('orcamento-success-msg');
        const orcamentoErrorMsg = document.getElementById('orcamento-error-msg');
        
        // --- Seletores Meus Pedidos ---
        const allOrdersTable = document.querySelector('#all-orders-table tbody');

        // --- Seletores Chatbot ---
        const floatingChatbot = document.getElementById('floatingChatbot');
        const chatbotButton = document.getElementById('chatbotButton');
        const chatbotWindow = document.getElementById('chatbotWindow');
        const chatbotClose = document.getElementById('chatbotClose');
        const chatbotInput = document.getElementById('chatbotInput');
        const chatbotSend = document.getElementById('chatbotSend');
        const chatbotMessages = document.getElementById('chatbotMessages');
        const previewClose = document.getElementById('previewClose');
        const minimizedIcon = document.getElementById('minimizedIcon');
        const previewMessageEl = document.getElementById('preview-message-text');
        let chatHistory = [];
        
        // --- Seletores Di치logo ---
        const customDialogModal = document.getElementById('custom-dialog-modal');
        const dialogMessage = document.getElementById('dialog-message');
        const dialogOkBtn = document.getElementById('dialog-ok-btn');

        // --- Utils ---
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${CLIENT_TOKEN}`
            };
        }
        function formatCurrency(value) {
            if (value === null || value === undefined) return '-';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        function formatDate(dateString) {
            if (!dateString) return '-';
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('pt-BR', options);
        }
        function getStatusClass(status) {
            if (!status) return 'status-default';
            const statusKey = status.replace(/\s/g, '-').replace(/[()]/g, '');
            return `status-${statusKey}`;
        }
        function showCustomAlert(message) {
            dialogMessage.textContent = message;
            customDialogModal.style.display = 'flex';
        }
        dialogOkBtn.addEventListener('click', () => {
            customDialogModal.style.display = 'none';
        });

        // --- L칩gica de View (Troca de Painel) ---
        function switchView(viewId) {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(`${viewId}-view`).classList.add('active');

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.view === viewId) {
                    link.classList.add('active');
                    pageTitle.textContent = link.querySelector('span').textContent;
                }
            });

            // Carrega dados sob demanda
            if (viewId === 'dashboard') loadDashboardStats();
            if (viewId === 'novo-orcamento') loadProductsForOrcamento();
            if (viewId === 'meus-pedidos') loadOrderHistory();
            if (viewId === 'falar-chat') toggleChat(true); // For칞a abertura do chat
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(e.currentTarget.dataset.view);
            });
        });

        // --- AUTENTICA칂츾O ---
        function showPortal() {
            loginScreen.style.display = 'none';
            clientPortal.style.display = 'flex';
            clientNameDisplay.textContent = CLIENT_NAME;
            floatingChatbot.style.display = 'block'; // Mostra o chatbot
            switchView('dashboard');
            startChatbotSession(); // Inicia a sess칚o do chatbot
        }
        function showLogin() {
            loginScreen.style.display = 'flex';
            clientPortal.style.display = 'none';
            floatingChatbot.style.display = 'none'; // Esconde o chatbot
            
            localStorage.removeItem('oceano_client_token');
            localStorage.removeItem('oceano_client_id');
            localStorage.removeItem('oceano_client_name');
            CLIENT_TOKEN = null;
            CLIENT_ID = null;
            CLIENT_NAME = null;
            chatHistory = [];
        }
        
        async function handleLogin(e) {
             e.preventDefault();
             const codigo = document.getElementById('client-codigo').value; 
             loginErrorMsg.style.display = 'none';
             loginForm.querySelector('button').disabled = true;

             try {
                 const response = await fetch(`${API_CLIENT_URL}/login`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ codigo_acesso: codigo })
                 });
                 const data = await response.json();
                 if (response.ok) {
                     CLIENT_TOKEN = data.token;
                     CLIENT_ID = data.cliente_id;
                     CLIENT_NAME = data.nome_cliente;
                     localStorage.setItem('oceano_client_token', data.token); 
                     localStorage.setItem('oceano_client_id', data.cliente_id);
                     localStorage.setItem('oceano_client_name', data.nome_cliente);
                     showPortal();
                 } else {
                     loginErrorMsg.textContent = data.erro || 'C칩digo inv치lido.';
                     loginErrorMsg.style.display = 'block';
                 }
             } catch (error) {
                 loginErrorMsg.textContent = 'Erro de conex칚o com o servidor.';
                 loginErrorMsg.style.display = 'block';
             } finally {
                 loginForm.querySelector('button').disabled = false;
             }
         }
        logoutButton.addEventListener('click', showLogin);

        // --- DASHBOARD ---
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_CLIENT_URL}/dashboard`, { headers: getAuthHeaders() });
                if (response.status === 401) return showLogin();
                const stats = await response.json();
                statAguardandoPagamento.textContent = stats.stat_aguardando_pagamento;
                statEmProducao.textContent = stats.stat_em_producao;
                statProntos.textContent = stats.stat_prontos;
            } catch (e) {
                console.error("Erro stats:", e);
            }
            loadOrderHistory(true); // Carrega a tabela de 칰ltimos pedidos
        }

        // --- MEUS PEDIDOS & 칔LTIMOS PEDIDOS (Dashboard) ---
        async function loadOrderHistory(isDashboard = false) {
            const tableBody = isDashboard ? lastOrdersTable : allOrdersTable;
            const cols = isDashboard ? 5 : 7;
            tableBody.innerHTML = `<tr><td colspan="${cols}" style="text-align: center;">Carregando...</td></tr>`;
            
            try {
                const response = await fetch(`${API_CLIENT_URL}/orcamentos`, { headers: getAuthHeaders() });
                if (response.status === 401) return showLogin();
                let orders = await response.json();
                
                if (isDashboard) {
                    orders = orders.slice(0, 5); // Pega s칩 os 5 primeiros pro dashboard
                }
                
                tableBody.innerHTML = '';
                if (orders.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${cols}" style="text-align: center;">Nenhum documento encontrado.</td></tr>`;
                    return;
                }
                
                orders.forEach(o => {
                    const statusClass = getStatusClass(o.status);
                    const row = tableBody.insertRow();
                    
                    let rowHTML = `
                        <td>#${o.id}</td>
                        <td>${o.tipo === 'orcamento' ? 'Or칞amento' : 'Pedido'}</td>
                        <td><span class="status-badge ${statusClass}">${o.status}</span></td>
                        <td>${formatCurrency(o.valor_final_total)}</td>
                        <td>${o.codigo_rastreio || '-'}</td>
                    `;
                    
                    if (!isDashboard) {
                        rowHTML = `
                            <td>#${o.id}</td>
                            <td>${o.tipo === 'orcamento' ? 'Or칞amento' : 'Pedido'}</td>
                            <td>${formatDate(o.data_criacao)}</td>
                            <td><span class="status-badge ${statusClass}">${o.status}</span></td>
                            <td>${formatCurrency(o.valor_final_total)}</td>
                            <td>${o.codigo_rastreio || '-'}</td>
                            <td>${o.chave_pix || '-'}</td>
                        `;
                    }
                    row.innerHTML = rowHTML;
                });
                
            } catch (error) {
                console.error('Erro ao carregar hist칩rico:', error);
                tableBody.innerHTML = `<tr><td colspan="${cols}" style="color:var(--status-rejected);">Erro ao carregar.</td></tr>`;
            }
        }
        
        // --- NOVO OR칂AMENTO (L칩gica do Carrinho) ---
        async function loadProductsForOrcamento() {
            productListContainer.innerHTML = '<p style="padding: 2rem; text-align: center;">Carregando produtos...</p>';
            try {
                const response = await fetch(API_PRODUTOS_URL); // API P칰blica
                if (!response.ok) throw new Error('Falha ao carregar produtos.');
                
                const products = await response.json();
                productListContainer.innerHTML = '';
                productsMap = {};
                
                products.forEach(p => {
                    productsMap[p.id] = p; // Salva no mapa
                    const item = document.createElement('div');
                    item.className = 'product-item';
                    item.innerHTML = `
                        <div class="product-image-box">
                            <img src="${p.imagem_principal_url || '/static/oceanologo.png'}" alt="${p.nome_produto}" onerror="this.src='/static/oceanologo.png';">
                        </div>
                        <div class="product-details">
                            <h3>${p.nome_produto} (${p.codigo_produto || 'S/C'})</h3>
                            <p>${p.descricao_curta || 'Sem descri칞칚o.'}</p>
                        </div>
                        <div class="product-actions">
                            <input type="number" min="1" value="1" id="qty-${p.id}" placeholder="Qtd.">
                            <button class="btn btn-primary" onclick="addToOrcamentoCart(${p.id})">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;
                    productListContainer.appendChild(item);
                });
            } catch (error) {
                productListContainer.innerHTML = '<p style="color:var(--status-rejected);">Erro ao carregar produtos.</p>';
            }
        }

        function addToOrcamentoCart(productId) {
            const product = productsMap[productId];
            if (!product) return;
            const quantity = parseInt(document.getElementById(`qty-${productId}`).value) || 1;
            
            // Adiciona ou atualiza no carrinho
            orcamentoCart[productId] = {
                produto_id: product.id,
                nome: product.nome_produto,
                quantidade: quantity,
                observacao: '' // Opcional: pode adicionar um campo de obs
            };
            updateOrcamentoCartUI();
        }

        function removeFromOrcamentoCart(productId) {
            delete orcamentoCart[productId];
            updateOrcamentoCartUI();
        }

        function updateOrcamentoCartUI() {
            const productIds = Object.keys(orcamentoCart);
            if (productIds.length === 0) {
                cartItemsList.innerHTML = '';
                cartEmptyMsg.style.display = 'block';
                return;
            }
            
            cartEmptyMsg.style.display = 'none';
            cartItemsList.innerHTML = '';
            
            productIds.forEach(id => {
                const item = orcamentoCart[id];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <p>
                        <strong>${item.quantidade}x</strong> ${item.nome}
                        <button onclick="removeFromOrcamentoCart(${id})" style="float: right; color: var(--status-rejected); background: none; border: none; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </p>
                `;
                cartItemsList.appendChild(itemDiv);
            });
        }
        
        submitOrcamentoBtn.addEventListener('click', async () => {
            const itens = Object.values(orcamentoCart);
            if (itens.length === 0) {
                showCustomAlert('Seu carrinho de or칞amento est치 vazio.');
                return;
            }

            submitOrcamentoBtn.disabled = true;
            submitOrcamentoBtn.textContent = 'Enviando...';
            orcamentoErrorMsg.style.display = 'none';
            orcamentoSuccessMsg.style.display = 'none';

            try {
                const response = await fetch(`${API_CLIENT_URL}/orcamentos/novo`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ itens: itens })
                });
                const data = await response.json();
                if (response.ok) {
                    orcamentoSuccessMsg.textContent = data.mensagem;
                    orcamentoSuccessMsg.style.display = 'block';
                    orcamentoCart = {};
                    updateOrcamentoCartUI();
                    switchView('meus-pedidos'); // Pula para a tela de pedidos
                } else {
                    throw new Error(data.erro || 'Falha ao enviar solicita칞칚o.');
                }
            } catch (error) {
                orcamentoErrorMsg.textContent = error.message;
                orcamentoErrorMsg.style.display = 'block';
            } finally {
                submitOrcamentoBtn.disabled = false;
                submitOrcamentoBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicita칞칚o';
            }
        });


        // --- CHATBOT (L칩gica de UI e API) ---
        
        function getCurrentTime() {
            return new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function addChatMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            let formattedText = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            if (!isUser) {
                chatHistory.push({ role: 'model', content: text }); // Gemini usa 'model' para o bot
            } else {
                chatHistory.push({ role: 'user', content: text });
            }

            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-${isUser ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">${formattedText}</div>
                    <div class="message-time">${getCurrentTime()}</div>
                </div>
            `;
            chatbotMessages.appendChild(messageDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot typing-message';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>
            `;
            chatbotMessages.appendChild(typingDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typing-indicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function minimizePreview() {
            chatbotButton.classList.add('hidden');
            minimizedIcon.classList.add('minimized');
        }
        function maximizePreview() {
            chatbotButton.classList.remove('hidden');
            minimizedIcon.classList.remove('minimized');
        }
        
        function toggleChat(forceOpen = false) {
            const isActive = chatbotWindow.classList.contains('active');
            if (isActive && !forceOpen) {
                chatbotWindow.classList.remove('active');
                chatbotButton.classList.remove('hidden');
                minimizedIcon.classList.remove('minimized');
            } else {
                chatbotWindow.classList.add('active');
                chatbotButton.classList.add('hidden');
                minimizedIcon.classList.add('minimized');
                setTimeout(() => chatbotInput.focus(), 300);
            }
        }

        function startChatbotSession() {
            chatHistory = [];
            chatbotMessages.innerHTML = '';
            addChatMessage(`Ol치, ${CLIENT_NAME}! Sou o Oceano Bot, seu assistente. Como posso ajudar a rastrear um pedido ou encontrar um produto?`, false);
        }
        
        async function sendChatMessage() {
            const messageText = chatbotInput.value.trim();
            if (messageText === '' || chatbotSend.disabled) return;

            addChatMessage(messageText, true); 
            chatbotInput.value = '';
            chatbotSend.disabled = true;
            showTypingIndicator();
            
            try {
                // Prepara o hist칩rico para o formato do app.py
                const historyForAPI = chatHistory.slice(0, -1).map(item => ({
                    role: item.role === 'model' ? 'bot' : 'user', // O app.py V3 esperava 'bot'
                    content: item.content
                }));
                
                const payload = {
                    message: messageText,
                    history: historyForAPI 
                };

                const response = await fetch(API_CHAT_URL, {
                    method: 'POST',
                    headers: getAuthHeaders(), // Envia o token do cliente
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.erro || "Erro na API do chat.");
                
                removeTypingIndicator();
                addChatMessage(result.response, false);

            } catch (err) {
                removeTypingIndicator();
                console.error("Erro no Chatbot:", err);
                addChatMessage(`Desculpe, tive um problema de conex칚o. Por favor, tente novamente.`, false);
            } finally {
                chatbotSend.disabled = false;
                chatbotInput.focus();
            }
        }

        // --- Listeners do Chatbot ---
        chatbotButton.addEventListener('click', toggleChat);
        chatbotClose.addEventListener('click', toggleChat);
        previewClose.addEventListener('click', (e) => { e.stopPropagation(); minimizePreview(); });
        minimizedIcon.addEventListener('click', toggleChat);
        chatbotSend.addEventListener('click', sendChatMessage);
        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // --- INICIALIZA칂츾O GERAL ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // *** CORRE칂츾O AQUI ***
            loginForm.addEventListener('submit', handleLogin);
            
            CLIENT_TOKEN = localStorage.getItem('oceano_client_token');
            CLIENT_ID = localStorage.getItem('oceano_client_id');
            CLIENT_NAME = localStorage.getItem('oceano_client_name');
            if (CLIENT_TOKEN && CLIENT_ID && CLIENT_NAME) {
                showPortal();
            } else {
                showLogin();
            }
        });
    </script>
</body>
</html>